
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Locker Management System</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Sortable.js for drag and drop functionality -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
      @media print {
        .print-hide {
          display: none !important;
        }
        .print-show {
          display: block !important;
        }
      }

      .even-row {
        background-color: #f3f4f6;
      }

      .modal {
        transition: opacity 0.25s ease;
      }

      body.modal-active {
        overflow-x: hidden;
        overflow-y: visible !important;
      }

      /* Add this to ensure action buttons are visible */
      .flex.space-x-2 {
        display: flex;
        visibility: visible;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Login Screen -->
    <div
      id="login-screen"
      class="flex min-h-screen items-center justify-center p-4"
    >
      <div class="w-full max-w-md bg-white rounded-lg shadow-md">
        <div class="p-6 space-y-4">
          <div
            class="text-2xl font-bold text-center flex items-center justify-center gap-2"
          >
		  
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="h-6 w-6"
            >
              <rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Locker Management System
          </div>
          <form id="login-form" class="space-y-4">
            <div class="space-y-2">
              <input
                id="password"
                type="password"
                placeholder="Enter password"
                class="w-full px-3 py-2 border rounded-md"
                required
              />
              <p id="login-error" class="text-sm text-red-500 hidden"></p>
            </div>
            <button
              type="submit"
              class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-500"
            >
              Login
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Main Application (hidden initially) -->
    <div id="app" class="container mx-auto py-6 space-y-6 hidden">
      <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold">Locker Management System</h1>
        <div class="print-hide flex space-x-2">
          <button
            id="print-btn"
            class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 flex items-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="h-4 w-4 mr-2"
            >
              <polyline points="6 9 6 2 18 2 18 9"></polyline>
              <path
                d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"
              ></path>
              <rect width="12" height="8" x="6" y="14"></rect>
            </svg>
            Print
          </button>
          <button
            id="import-csv-btn"
            class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 flex items-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="h-4 w-4 mr-2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            Import CSV
          </button>
          <button
            id="export-csv-btn"
            class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="h-4 w-4 mr-2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export CSV
          </button>
          <button
            id="add-btn"
            class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="h-4 w-4 mr-2"
            >
              <path d="M5 12h14"></path>
              <path d="M12 5v14"></path>
            </svg>
            Add Locker
          </button>
        </div>
      </div>

      <!-- Search and Filters -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 print-hide">
        <div>
          <div class="relative">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="absolute left-2 top-2.5 h-4 w-4 text-gray-400"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.3-4.3"></path>
            </svg>
            <input
              id="search-input"
              placeholder="Search..."
              class="w-full pl-8 pr-4 py-2 border rounded-md"
            />
          </div>
        </div>

        <div>
          <select id="filter-store" class="w-full px-3 py-2 border rounded-md">
            <option value="">All Stores</option>
          </select>
        </div>

        <div>
          <select id="filter-city" class="w-full px-3 py-2 border rounded-md">
            <option value="">All Cities</option>
          </select>
        </div>

        <div>
          <select id="filter-route" class="w-full px-3 py-2 border rounded-md">
            <option value="">All Routes</option>
          </select>
        </div>
      </div>

      <!-- Column Management -->
      <div class="print-hide">
        <div class="relative inline-block text-left">
          <button
            id="column-btn"
            class="flex items-center bg-white border rounded-md px-4 py-2 hover:bg-gray-50"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="h-4 w-4 mr-2"
            >
              <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
            Manage Columns
          </button>
          <div
            id="column-dropdown"
            class="hidden absolute left-0 mt-2 w-56 bg-white border rounded-md shadow-lg z-10"
          >
            <div class="p-2 space-y-1" id="column-options">
              <!-- Column options will be added here dynamically -->
            </div>
          </div>
        </div>
      </div>

      <!-- Table Container -->
      <div class="border rounded-md overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr id="table-header">
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider print-hide"
              >
                <!-- Drag handle column -->
              </th>
              <!-- Table headers will be added here dynamically -->
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider print-hide"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody id="table-body" class="bg-white divide-y divide-gray-200">
            <!-- Table rows will be added here dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal for Add/Edit -->
    <div
      id="modal"
      class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50"
    >
      <div
        class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"
      ></div>

      <div
        class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-screen md:max-h-[90vh]"
      >
        <div class="modal-content py-4 text-left px-6">
          <div class="flex justify-between items-center pb-3">
            <p class="text-2xl font-bold" id="modal-title">Add New Locker</p>
            <button id="modal-close" class="modal-close cursor-pointer z-50">
              <svg
                class="fill-current text-black"
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 18 18"
              >
                <path
                  d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"
                ></path>
              </svg>
            </button>
          </div>

          <form id="locker-form" class="space-y-4">
            <input type="hidden" id="locker-id" />

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="space-y-2">
                <label
                  for="locker_id"
                  class="block text-sm font-medium text-gray-700"
                  >Locker ID</label
                >
                <input
                  id="locker_id"
                  name="locker_id"
                  class="w-full px-3 py-2 border rounded-md"
                  required
                />
              </div>

              <div class="space-y-2">
                <label
                  for="store"
                  class="block text-sm font-medium text-gray-700"
                  >Store</label
                >
                <input
                  id="store"
                  name="store"
                  class="w-full px-3 py-2 border rounded-md"
                  required
                />
              </div>

              <div class="space-y-2">
                <label
                  for="route"
                  class="block text-sm font-medium text-gray-700"
                  >Route</label
                >
                <input
                  id="route"
                  name="route"
                  class="w-full px-3 py-2 border rounded-md"
                />
              </div>

              <div class="space-y-2">
                <label
                  for="city"
                  class="block text-sm font-medium text-gray-700"
                  >City</label
                >
                <input
                  id="city"
                  name="city"
                  class="w-full px-3 py-2 border rounded-md"
                />
              </div>

              <div class="space-y-2">
                <label
                  for="address"
                  class="block text-sm font-medium text-gray-700"
                  >Address</label
                >
                <input
                  id="address"
                  name="address"
                  class="w-full px-3 py-2 border rounded-md"
                />
              </div>

              <div class="space-y-2">
                <label
                  for="location_map"
                  class="block text-sm font-medium text-gray-700"
                  >Location Map</label
                >
                <input
                  id="location_map"
                  name="location_map"
                  class="w-full px-3 py-2 border rounded-md"
                />
              </div>

              <div class="space-y-2">
                <label
                  for="router_sn"
                  class="block text-sm font-medium text-gray-700"
                  >Router SN</label
                >
                <input
                  id="router_sn"
                  name="router_sn"
                  class="w-full px-3 py-2 border rounded-md"
                />
              </div>

              <div class="space-y-2">
                <label
                  for="sim_number"
                  class="block text-sm font-medium text-gray-700"
                  >SIM Number</label
                >
                <input
                  id="sim_number"
                  name="sim_number"
                  class="w-full px-3 py-2 border rounded-md"
                />
              </div>

              <div class="space-y-2">
                <label
                  for="dvr_sn"
                  class="block text-sm font-medium text-gray-700"
                  >DVR SN</label
                >
                <input
                  id="dvr_sn"
                  name="dvr_sn"
                  class="w-full px-3 py-2 border rounded-md"
                />
              </div>

              <div class="space-y-2">
                <label for="gps" class="block text-sm font-medium text-gray-700"
                  >GPS</label
                >
                <input
                  id="gps"
                  name="gps"
                  class="w-full px-3 py-2 border rounded-md"
                />
              </div>

              <div class="space-y-2">
                <label
                  for="gps_sim"
                  class="block text-sm font-medium text-gray-700"
                  >GPS SIM</label
                >
                <input
                  id="gps_sim"
                  name="gps_sim"
                  class="w-full px-3 py-2 border rounded-md"
                />
              </div>
            </div>

            <div class="space-y-2">
              <label
                for="qr_location"
                class="block text-sm font-medium text-gray-700"
                >QR Location</label
              >
              <div class="flex items-center space-x-4">
                <button
                  type="button"
                  id="qr-upload-btn"
                  class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-md"
                >
                  Upload QR Code
                </button>
                <input
                  type="file"
                  id="qr-file"
                  accept="image/png"
                  class="hidden"
                />
                <div id="qr-preview-container" class="hidden relative">
                  <img
                    id="qr-preview"
                    class="w-20 h-20 object-contain border"
                  />
                  <button
                    type="button"
                    id="qr-remove-btn"
                    class="absolute -top-2 -right-2 h-6 w-6 rounded-full bg-white border flex items-center justify-center"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="h-3 w-3"
                    >
                      <path d="M18 6 6 18"></path>
                      <path d="m6 6 12 12"></path>
                    </svg>
                  </button>
                </div>
              </div>
              <input type="hidden" id="qr_location" name="qr_location" />
            </div>

            <div class="space-y-2">
              <label for="notes" class="block text-sm font-medium text-gray-700"
                >Notes</label
              >
              <textarea
                id="notes"
                name="notes"
                class="w-full px-3 py-2 border rounded-md min-h-[100px]"
              ></textarea>
            </div>

            <div class="flex justify-end pt-2 space-x-4">
              <button
                type="button"
                id="modal-cancel"
                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="h-4 w-4 mr-2"
                >
                  <path
                    d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                  ></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Hidden file input for CSV import -->
    <input type="file" id="csv-file-input" accept=".csv" class="hidden" />

    <script>
      // Configuration
      const DEFAULT_PASSWORD = "123456";
      const STORAGE_KEY = "lockers_data";

      // State variables
      let lockers = [];
      let filteredLockers = [];
      let currentLocker = null;
      let columnVisibility = {
        locker_id: true,
        store: true,
        route: true,
        address: true,
        city: true,
        location_map: true,
        qr_location: true,
        router_sn: true,
        sim_number: true,
        dvr_sn: true,
        gps: true,
        gps_sim: true,
        notes: true,
      };
      let columnOrder = [
        "locker_id",
        "store",
        "route",
        "address",
        "city",
        "location_map",
        "qr_location",
        "router_sn",
        "sim_number",
        "dvr_sn",
        "gps",
        "gps_sim",
        "notes",
      ];

      // DOM Elements
      const loginScreen = document.getElementById("login-screen");
      const loginForm = document.getElementById("login-form");
      const loginError = document.getElementById("login-error");
      const appContainer = document.getElementById("app");
      const searchInput = document.getElementById("search-input");
      const filterStore = document.getElementById("filter-store");
      const filterCity = document.getElementById("filter-city");
      const filterRoute = document.getElementById("filter-route");
      const tableHeader = document.getElementById("table-header");
      const tableBody = document.getElementById("table-body");
      const addBtn = document.getElementById("add-btn");
      const printBtn = document.getElementById("print-btn");
      const modal = document.getElementById("modal");
      const modalTitle = document.getElementById("modal-title");
      const modalClose = document.getElementById("modal-close");
      const modalCancel = document.getElementById("modal-cancel");
      const lockerForm = document.getElementById("locker-form");
      const columnBtn = document.getElementById("column-btn");
      const columnDropdown = document.getElementById("column-dropdown");
      const columnOptions = document.getElementById("column-options");
      const qrUploadBtn = document.getElementById("qr-upload-btn");
      const qrFile = document.getElementById("qr-file");
      const qrPreviewContainer = document.getElementById(
        "qr-preview-container"
      );
      const qrPreview = document.getElementById("qr-preview");
      const qrRemoveBtn = document.getElementById("qr-remove-btn");
      const qrLocationInput = document.getElementById("qr_location");

      // Check if user is authenticated
      function checkAuth() {
        const isAuthenticated =
          sessionStorage.getItem("authenticated") === "true";
        if (isAuthenticated) {
          loginScreen.classList.add("hidden");
          appContainer.classList.remove("hidden");
          loadData();
        }
      }

      // Login form submission
      loginForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const password = document.getElementById("password").value;

        if (password === DEFAULT_PASSWORD) {
          sessionStorage.setItem("authenticated", "true");
          loginScreen.classList.add("hidden");
          appContainer.classList.remove("hidden");
          loadData();
        } else {
          loginError.textContent = "Invalid password";
          loginError.classList.remove("hidden");
        }
      });

      // Load data from localStorage
      function loadData() {
        try {
          const storedData = localStorage.getItem(STORAGE_KEY);
          if (storedData) {
            lockers = JSON.parse(storedData);
          }

          updateFilters();
          applyFilters();
          renderColumnOptions();
        } catch (error) {
          console.error("Failed to load data:", error);
        }
      }

      // Save data to localStorage
      function saveData() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(lockers));
        } catch (error) {
          console.error("Failed to save data:", error);
        }
      }

      // Update filter dropdowns with unique values
      function updateFilters() {
        const stores = [
          ...new Set(lockers.map((locker) => locker.store).filter(Boolean)),
        ];
        const cities = [
          ...new Set(lockers.map((locker) => locker.city).filter(Boolean)),
        ];
        const routes = [
          ...new Set(lockers.map((locker) => locker.route).filter(Boolean)),
        ];

        // Clear existing options except the first one
        filterStore.innerHTML = '<option value="">All Stores</option>';
        filterCity.innerHTML = '<option value="">All Cities</option>';
        filterRoute.innerHTML = '<option value="">All Routes</option>';

        // Add new options
        stores.forEach((store) => {
          const option = document.createElement("option");
          option.value = store;
          option.textContent = store;
          filterStore.appendChild(option);
        });

        cities.forEach((city) => {
          const option = document.createElement("option");
          option.value = city;
          option.textContent = city;
          filterCity.appendChild(option);
        });

        routes.forEach((route) => {
          const option = document.createElement("option");
          option.value = route;
          option.textContent = route;
          filterRoute.appendChild(option);
        });
      }

      // Apply filters and search
      function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const storeFilter = filterStore.value;
        const cityFilter = filterCity.value;
        const routeFilter = filterRoute.value;

        filteredLockers = lockers.filter((locker) => {
          // Search term filter
          const matchesSearch =
            !searchTerm ||
            Object.values(locker).some(
              (value) =>
                value &&
                typeof value === "string" &&
                value.toLowerCase().includes(searchTerm)
            );

          // Dropdown filters
          const matchesStore = !storeFilter || locker.store === storeFilter;
          const matchesCity = !cityFilter || locker.city === cityFilter;
          const matchesRoute = !routeFilter || locker.route === routeFilter;

          return matchesSearch && matchesStore && matchesCity && matchesRoute;
        });

        renderTable();
      }

      // Render table headers
      function renderTableHeaders() {
        // Clear existing headers except the first and last ones (drag handle and actions)
        const firstChild = tableHeader.firstChild;
        const lastChild = tableHeader.lastChild;
        tableHeader.innerHTML = "";
        tableHeader.appendChild(firstChild);

        // Add column headers based on visibility and order
        columnOrder.forEach((column) => {
          if (columnVisibility[column]) {
            const th = document.createElement("th");
            th.className =
              "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
            th.textContent = formatColumnName(column);
            tableHeader.appendChild(th);
          }
        });

        // Make sure the Actions header is correctly added
        const actionsHeader = document.createElement("th");
        actionsHeader.className =
          "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider print-hide";
        actionsHeader.textContent = "Actions";
        tableHeader.appendChild(actionsHeader);
      }

      // Format column name for display
      function formatColumnName(column) {
        return column
          .split("_")
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      // Render table rows
      function renderTable() {
        renderTableHeaders();
        tableBody.innerHTML = "";

        filteredLockers.forEach((locker, index) => {
          const row = document.createElement("tr");
          row.dataset.id = locker.locker_id;
          row.className = index % 2 === 1 ? "even-row" : "";

          // Data cells
          columnOrder.forEach((column) => {
            if (columnVisibility[column]) {
              const cell = document.createElement("td");
              cell.className = "px-6 py-4 whitespace-nowrap";

              if (column === "qr_location" && locker[column]) {
                cell.innerHTML = `<img src="${locker[column]}" alt="QR Code" class="w-12 h-12 object-contain">`;
              } else {
                cell.textContent = locker[column] || "";
              }

              row.appendChild(cell);
            }
          });

          // Actions cell
          const actionsCell = document.createElement("td");
          actionsCell.className =
            "px-6 py-4 whitespace-nowrap text-right text-sm font-medium print-hide";
          actionsCell.innerHTML = `
          <div class="flex space-x-2 justify-end">
            <button class="edit-btn bg-blue-100 text-blue-600 p-1 rounded hover:bg-blue-200" data-id="${
              locker.locker_id
            }">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
                <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
                <path d="m15 5 4 4"></path>
              </svg>
            </button>
            <button class="delete-btn bg-red-100 text-red-600 p-1 rounded hover:bg-red-200" data-id="${
              locker.locker_id
            }">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
                <path d="M3 6h18"></path>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                <line x1="10" x2="10" y1="11" y2="17"></line>
                <line x1="14" x2="14" y1="11" y2="17"></line>
              </svg>
            </button>
            <button class="move-up-btn bg-gray-100 text-gray-600 p-1 rounded hover:bg-gray-200 ${
              index === 0 ? "opacity-50 cursor-not-allowed" : ""
            }" data-index="${index}" ${index === 0 ? "disabled" : ""}>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
                <path d="m12 19-7-7 7-7"></path>
                <path d="M19 12H5"></path>
              </svg>
            </button>
            <button class="move-down-btn bg-gray-100 text-gray-600 p-1 rounded hover:bg-gray-200 ${
              index === filteredLockers.length - 1
                ? "opacity-50 cursor-not-allowed"
                : ""
            }" data-index="${index}" ${
            index === filteredLockers.length - 1 ? "disabled" : ""
          }>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
                <path d="m12 5 7 7-7 7"></path>
                <path d="M5 12h14"></path>
              </svg>
            </button>
          </div>
        `;
          row.appendChild(actionsCell);

          tableBody.appendChild(row);
        });

        // Initialize Sortable for drag and drop
        if (tableBody.children.length > 0) {
          new Sortable(tableBody, {
            handle: ".cursor-move",
            animation: 150,
            onEnd: function (evt) {
              const itemId = evt.item.dataset.id;
              const oldIndex = evt.oldIndex;
              const newIndex = evt.newIndex;

              // Update the filtered lockers array
              const [movedItem] = filteredLockers.splice(oldIndex, 1);
              filteredLockers.splice(newIndex, 0, movedItem);

              // Update the main lockers array
              const mainIndex = lockers.findIndex(
                (l) => l.locker_id === itemId
              );
              const targetLocker = filteredLockers[newIndex];
              const targetIndex = lockers.findIndex(
                (l) => l.locker_id === targetLocker.locker_id
              );

              if (mainIndex !== -1) {
                const [movedMainItem] = lockers.splice(mainIndex, 1);
                lockers.splice(targetIndex, 0, movedMainItem);
                saveData();
              }
            },
          });
        }

        // Add event listeners for row actions
        document.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const id = this.dataset.id;
            const locker = lockers.find((l) => l.locker_id === id);
            if (locker) {
              openEditModal(locker);
            }
          });
        });

        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const id = this.dataset.id;
            if (confirm("Are you sure you want to delete this locker?")) {
              deleteLocker(id);
            }
          });
        });

        document.querySelectorAll(".move-up-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            if (this.disabled) return;
            const index = parseInt(this.dataset.index);
            moveRow(index, "up");
          });
        });

        document.querySelectorAll(".move-down-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            if (this.disabled) return;
            const index = parseInt(this.dataset.index);
            moveRow(index, "down");
          });
        });
      }

      // Render column options for dropdown
      function renderColumnOptions() {
        columnOptions.innerHTML = "";

        columnOrder.forEach((column, index) => {
          const item = document.createElement("div");
          item.className =
            "flex justify-between items-center p-2 hover:bg-gray-100 rounded";

          const displayName = formatColumnName(column);

          item.innerHTML = `
          <div class="flex items-center">
            <button class="toggle-column h-8 w-8 flex items-center justify-center" data-column="${column}">
              ${
                columnVisibility[column]
                  ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>'
                  : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>'
              }
            </button>
            <span class="ml-2">${displayName}</span>
          </div>
          <div class="flex">
            <button class="move-column-left h-8 w-8 flex items-center justify-center ${
              index === 0 ? "opacity-50 cursor-not-allowed" : ""
            }" data-column="${column}" ${index === 0 ? "disabled" : ""}>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="m18 15-6-6-6 6"></path></svg>
            </button>
            <button class="move-column-right h-8 w-8 flex items-center justify-center ${
              index === columnOrder.length - 1
                ? "opacity-50 cursor-not-allowed"
                : ""
            }" data-column="${column}" ${
            index === columnOrder.length - 1 ? "disabled" : ""
          }>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="m6 9 6 6 6-6"></path></svg>
            </button>
          </div>
        `;

          columnOptions.appendChild(item);
        });

        // Add event listeners for column actions
        document.querySelectorAll(".toggle-column").forEach((btn) => {
          btn.addEventListener("click", function () {
            const column = this.dataset.column;
            columnVisibility[column] = !columnVisibility[column];
            renderColumnOptions();
            renderTable();
          });
        });

        document.querySelectorAll(".move-column-left").forEach((btn) => {
          btn.addEventListener("click", function () {
            if (this.disabled) return;
            const column = this.dataset.column;
            moveColumn(column, "left");
          });
        });

        document.querySelectorAll(".move-column-right").forEach((btn) => {
          btn.addEventListener("click", function () {
            if (this.disabled) return;
            const column = this.dataset.column;
            moveColumn(column, "right");
          });
        });
      }

      // Move a column in the order
      function moveColumn(column, direction) {
        const currentIndex = columnOrder.indexOf(column);
        if (
          (direction === "left" && currentIndex > 0) ||
          (direction === "right" && currentIndex < columnOrder.length - 1)
        ) {
          const newIndex =
            direction === "left" ? currentIndex - 1 : currentIndex + 1;
          const newOrder = [...columnOrder];
          newOrder.splice(currentIndex, 1);
          newOrder.splice(newIndex, 0, column);
          columnOrder = newOrder;
          renderColumnOptions();
          renderTable();
        }
      }

      // Move a row up or down
      function moveRow(index, direction) {
        if (
          (direction === "up" && index > 0) ||
          (direction === "down" && index < filteredLockers.length - 1)
        ) {
          const newIndex = direction === "up" ? index - 1 : index + 1;

          // Swap in filtered array
          const temp = filteredLockers[index];
          filteredLockers[index] = filteredLockers[newIndex];
          filteredLockers[newIndex] = temp;

          // Update main array
          const lockerId = temp.locker_id;
          const targetId = filteredLockers[index].locker_id;

          const lockerIndex = lockers.findIndex(
            (l) => l.locker_id === lockerId
          );
          const targetIndex = lockers.findIndex(
            (l) => l.locker_id === targetId
          );

          if (lockerIndex !== -1 && targetIndex !== -1) {
            const temp = lockers[lockerIndex];
            lockers[lockerIndex] = lockers[targetIndex];
            lockers[targetIndex] = temp;
            saveData();
          }

          renderTable();
        }
      }

      // Open modal for adding a new locker
      function openAddModal() {
        modalTitle.textContent = "Add New Locker";
        lockerForm.reset();
        document.getElementById("locker-id").value = "";
        qrPreviewContainer.classList.add("hidden");
        qrLocationInput.value = "";
        currentLocker = null;

        openModal();
      }

      // Open modal for editing a locker
      function openEditModal(locker) {
        modalTitle.textContent = "Edit Locker";

        // Fill form with locker data
        document.getElementById("locker-id").value = locker.locker_id;
        document.getElementById("locker_id").value = locker.locker_id;
        document.getElementById("store").value = locker.store || "";
        document.getElementById("route").value = locker.route || "";
        document.getElementById("address").value = locker.address || "";
        document.getElementById("city").value = locker.city || "";
        document.getElementById("location_map").value =
          locker.location_map || "";
        document.getElementById("router_sn").value = locker.router_sn || "";
        document.getElementById("sim_number").value = locker.sim_number || "";
        document.getElementById("dvr_sn").value = locker.dvr_sn || "";
        document.getElementById("gps").value = locker.gps || "";
        document.getElementById("gps_sim").value = locker.gps_sim || "";
        document.getElementById("notes").value = locker.notes || "";

        // Handle QR code preview
        if (locker.qr_location) {
          qrPreview.src = locker.qr_location;
          qrPreviewContainer.classList.remove("hidden");
          qrLocationInput.value = locker.qr_location;
        } else {
          qrPreviewContainer.classList.add("hidden");
          qrLocationInput.value = "";
        }

        currentLocker = { ...locker };

        openModal();
      }

      // Open modal
      function openModal() {
        modal.classList.remove("opacity-0", "pointer-events-none");
        document.body.classList.add("modal-active");
      }

      // Close modal
      function closeModal() {
        modal.classList.add("opacity-0", "pointer-events-none");
        document.body.classList.remove("modal-active");
      }

      // Save locker data
      function saveLocker(formData) {
        const lockerId = document.getElementById("locker-id").value;

        const newLocker = {
          locker_id: formData.get("locker_id"),
          store: formData.get("store"),
          route: formData.get("route"),
          address: formData.get("address"),
          city: formData.get("city"),
          location_map: formData.get("location_map"),
          qr_location: formData.get("qr_location"),
          router_sn: formData.get("router_sn"),
          sim_number: formData.get("sim_number"),
          dvr_sn: formData.get("dvr_sn"),
          gps: formData.get("gps"),
          gps_sim: formData.get("gps_sim"),
          notes: formData.get("notes"),
        };

        if (lockerId) {
          // Update existing locker
          const index = lockers.findIndex((l) => l.locker_id === lockerId);
          if (index !== -1) {
            lockers[index] = newLocker;
          }
        } else {
          // Add new locker
          lockers.push(newLocker);
        }

        saveData();
        updateFilters();
        applyFilters();
        closeModal();
      }

      // Delete a locker
      function deleteLocker(id) {
        lockers = lockers.filter((locker) => locker.locker_id !== id);
        saveData();
        updateFilters();
        applyFilters();
      }

      // Event Listeners
      document.addEventListener("DOMContentLoaded", checkAuth);

      // Search and filter events
      searchInput.addEventListener("input", applyFilters);
      filterStore.addEventListener("change", applyFilters);
      filterCity.addEventListener("change", applyFilters);
      filterRoute.addEventListener("change", applyFilters);

      // Add button
      addBtn.addEventListener("click", openAddModal);

      // Print button
      printBtn.addEventListener("click", function () {
        window.print();
      });

      // Modal close buttons
      modalClose.addEventListener("click", closeModal);
      modalCancel.addEventListener("click", closeModal);

      // Column management dropdown
      columnBtn.addEventListener("click", function () {
        columnDropdown.classList.toggle("hidden");
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        if (
          !columnBtn.contains(e.target) &&
          !columnDropdown.contains(e.target)
        ) {
          columnDropdown.classList.add("hidden");
        }
      });

      // QR code upload
      qrUploadBtn.addEventListener("click", function () {
        qrFile.click();
      });

      qrFile.addEventListener("change", function () {
        if (this.files && this.files[0]) {
          const file = this.files[0];
          const reader = new FileReader();

          reader.onload = function (e) {
            qrPreview.src = e.target.result;
            qrPreviewContainer.classList.remove("hidden");
            qrLocationInput.value = e.target.result;
          };

          reader.readAsDataURL(file);
        }
      });

      qrRemoveBtn.addEventListener("click", function () {
        qrPreviewContainer.classList.add("hidden");
        qrLocationInput.value = "";
        qrFile.value = "";
      });

      // Form submission
      lockerForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        saveLocker(formData);
      });

      // Save data to server (AJAX)
      function saveDataToServer() {
        // This is a placeholder for AJAX functionality
        // In a real application, you would implement this to save to a server
        const data = JSON.stringify(lockers);

        // Example AJAX call (commented out since there's no actual server)
        /*
      fetch('/api/lockers', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: data
      })
      .then(response => response.json())
      .then(data => {
        console.log('Success:', data);
      })
      .catch((error) => {
        console.error('Error:', error);
      });
      */

        // For now, we just save to localStorage
        saveData();
      }

      // Load data from server (AJAX)
      function loadDataFromServer() {
        // This is a placeholder for AJAX functionality
        // In a real application, you would implement this to load from a server

        // Example AJAX call (commented out since there's no actual server)
        /*
      fetch('/api/lockers')
      .then(response => response.json())
      .then(data => {
        lockers = data;
        updateFilters();
        applyFilters();
      })
      .catch((error) => {
        console.error('Error:', error);
        // Fall back to localStorage
        loadData();
      });
      */

        // For now, we just load from localStorage
        loadData();
      }

      // Add event listener for export CSV button
      const exportCsvBtn = document.getElementById("export-csv-btn");
      exportCsvBtn.addEventListener("click", exportTableToCSV);

      // Function to export table data to CSV
      function exportTableToCSV() {
        // Get visible columns
        const visibleColumns = columnOrder.filter(
          (column) => columnVisibility[column]
        );

        // Create CSV header row
        let csvContent =
          visibleColumns
            .map((column) => `"${formatColumnName(column)}"`)
            .join(",") + "\n";

        // Add data rows
        filteredLockers.forEach((locker) => {
          const row = visibleColumns
            .map((column) => {
              // Handle potential commas and quotes in the data
              const value = locker[column] || "";
              const escapedValue = value.toString().replace(/"/g, '""');
              return `"${escapedValue}"`;
            })
            .join(",");
          csvContent += row + "\n";
        });

        // Create download link
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");

        // Set download attributes
        const date = new Date().toISOString().slice(0, 10);
        link.setAttribute("href", url);
        link.setAttribute("download", `lockers_export_${date}.csv`);
        link.style.visibility = "hidden";

        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Add event listener for import CSV button
      const importCsvBtn = document.getElementById("import-csv-btn");
      const csvFileInput = document.getElementById("csv-file-input");

      importCsvBtn.addEventListener("click", function () {
        csvFileInput.click();
      });

      csvFileInput.addEventListener("change", function (e) {
        if (this.files && this.files[0]) {
          const file = this.files[0];
          const reader = new FileReader();

          reader.onload = function (e) {
            try {
              const csvData = e.target.result;
              importCSVData(csvData);
            } catch (error) {
              alert("Error importing CSV: " + error.message);
              console.error(error);
            }
          };

          reader.onerror = function () {
            alert("Error reading file");
          };

          reader.readAsText(file);
        }
      });

      function importCSVData(csvData) {
        // Split the CSV into rows
        const rows = csvData.split(/\r?\n/).filter((row) => row.trim());

        if (rows.length < 2) {
          alert("CSV file must contain a header row and at least one data row");
          return;
        }

        // Parse header row
        const headers = parseCSVRow(rows[0]).map(
          (header) =>
            header
              .toLowerCase()
              .replace(/\s+/g, "_") // Replace spaces with underscores
              .replace(/[^a-z0-9_]/g, "") // Remove special characters
        );

        // Validate header row contains required fields
        if (!headers.includes("locker_id") || !headers.includes("store")) {
          alert("CSV must contain at least 'Locker ID' and 'Store' columns");
          return;
        }

        // Confirm import
        if (
          !confirm(
            `Found ${
              rows.length - 1
            } records to import. This will add new lockers and update existing ones. Continue?`
          )
        ) {
          return;
        }

        // Track statistics
        let added = 0;
        let updated = 0;

        // Process data rows
        for (let i = 1; i < rows.length; i++) {
          const values = parseCSVRow(rows[i]);

          // Skip rows with insufficient data
          if (values.length < 2) continue;

          const lockerData = {};

          // Map CSV columns to locker properties
          headers.forEach((header, index) => {
            if (index < values.length) {
              lockerData[header] = values[index];
            }
          });

          // Skip rows without the required fields
          if (!lockerData.locker_id || !lockerData.store) continue;

          // Check if this locker already exists
          const existingIndex = lockers.findIndex(
            (l) => l.locker_id === lockerData.locker_id
          );

          if (existingIndex >= 0) {
            // Update existing locker
            lockers[existingIndex] = {
              ...lockers[existingIndex],
              ...lockerData,
            };
            updated++;
          } else {
            // Add as new locker
            lockers.push(lockerData);
            added++;
          }
        }

        // Save and update UI
        saveData();
        updateFilters();
        applyFilters();

        // Show results
        alert(
          `Import complete: ${added} lockers added, ${updated} lockers updated.`
        );

        // Reset file input
        csvFileInput.value = "";
      }

      function parseCSVRow(row) {
        const result = [];
        let insideQuotes = false;
        let currentValue = "";

        for (let i = 0; i < row.length; i++) {
          const char = row[i];

          if (char === '"') {
            // Handle quoted fields
            if (insideQuotes && i < row.length - 1 && row[i + 1] === '"') {
              // Escaped quote inside a quoted field
              currentValue += '"';
              i++; // Skip the next quote
            } else {
              // Start/end of a quoted field
              insideQuotes = !insideQuotes;
            }
          } else if (char === "," && !insideQuotes) {
            // End of field
            result.push(currentValue.trim());
            currentValue = "";
          } else {
            // Normal character
            currentValue += char;
          }
        }

        // Add the last field
        result.push(currentValue.trim());

        return result;
      }
    </script>
  </body>
</html>
